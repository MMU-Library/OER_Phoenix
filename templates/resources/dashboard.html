{% extends "base.html" %}
{% load oer_filters %}

{% block title %}OER Discovery Platform{% endblock %}

{% block content %}
<div class="mt-4 mb-4">
  <h1 class="mb-2">OER Discovery Platform</h1>
  <p class="text-muted">
    Find open alternatives and analyze Talis reading lists
  </p>
</div>

<div class="row mb-4">
  <!-- AI OER Search -->
  <div class="col-md-8 mb-3">
    <div class="card border-primary shadow-sm">
      <div class="card-header bg-primary bg-opacity-10">
        <h2 class="h5 mb-0">üîç Find Open Resources</h2>
      </div>
      <div class="card-body">
        <form method="post" action="{% url 'resources:ai_search' %}">
          {% csrf_token %}
          <div class="input-group input-group-lg">
            <input
              type="text"
              name="query"
              class="form-control"
              placeholder="e.g., 'qualitative research methods'"
              required
            >
            <button class="btn btn-primary" type="submit">Search</button>
          </div>
          <small class="form-text text-muted mt-2 d-block">
            Intelligent search across thousands of open textbooks, articles, and learning materials.
          </small>
        </form>
      </div>
    </div>
  </div>

  <!-- Talis Reading List Analysis -->
  <div class="col-md-4 mb-3">
    <div class="card shadow-sm">
      <div class="card-header">
        <h2 class="h5 mb-0">üìö Analyze Talis Reading List</h2>
      </div>
      <div class="card-body">
        <form
          method="post"
          enctype="multipart/form-data"
          action="{% url 'resources:talis_analyse_dashboard' %}"
        >
          {% csrf_token %}

          <div class="mb-3">
            <label for="id_dash_talis_csv" class="form-label">
              Upload CSV file from Talis Aspire
            </label>
            <input
              type="file"
              id="id_dash_talis_csv"
              name="dash_talis_csv"
              class="form-control form-control-sm"
              accept=".csv"
            >
            <small class="form-text text-muted">
              Export your reading list as CSV from Talis Aspire, then upload it here.
            </small>
          </div>

          <div class="mb-3">
            <label for="id_dash_talis_url" class="form-label">
              Or paste list URL
            </label>
            <input
              type="url"
              name="dash_talis_url"
              id="id_dash_talis_url"
              class="form-control form-control-sm"
              placeholder="https://mmu.rl.talis.com/lists/..."
            >
            <small class="form-text text-muted">
              Linked Data URL (experimental).
            </small>
          </div>

          <button type="submit" class="btn btn-secondary btn-sm w-100">
            Find OER Alternatives
          </button>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Quick stats row -->
<div class="row mb-4">
  <div class="col-md-4 mb-3">
    <div class="card text-center shadow-sm">
      <div class="card-body">
        <h3 class="h6 text-muted mb-2">Open Resources</h3>
        <p class="display-6 mb-2">{{ stats.total_resources|default:"0" }}</p>
        <small class="text-muted">
          Textbooks, articles, and course materials.
        </small>
      </div>
    </div>
  </div>

  <div class="col-md-4 mb-3">
    <div class="card text-center shadow-sm">
      <div class="card-body">
        <h3 class="h6 text-muted mb-2">Subject Areas</h3>
        {% if stats.distinct_subjects %}
          <p class="display-6 mb-2">{{ stats.distinct_subjects }}</p>
          <small class="text-muted">
            Distinct subjects across the corpus.
          </small>
        {% else %}
          <p class="display-6 mb-2 text-muted">In progress</p>
          <small class="text-muted">
            Subject metadata enrichment is scheduled; values will appear here after the next harvest.
          </small>
        {% endif %}
      </div>
    </div>
  </div>

  <div class="col-md-4 mb-3">
    <div class="card text-center shadow-sm">
      <div class="card-body">
        <h3 class="h6 text-muted mb-2">Resource Collections</h3>
        <p class="display-6 mb-2">{{ stats.active_sources|default:"0" }}</p>
        <small class="text-muted">
          OAPEN, DOAB, OER Commons, and more.
        </small>
      </div>
    </div>
  </div>
</div>

<div class="mb-3">
  <button
    class="btn btn-link btn-sm p-0"
    type="button"
    data-bs-toggle="collapse"
    data-bs-target="#why_dashboard_stats"
    aria-expanded="false"
    aria-controls="why_dashboard_stats"
  >
    Why these numbers?
  </button>
  <div class="collapse mt-1" id="why_dashboard_stats">
    <small class="text-muted">
      ‚ÄúOpen Resources‚Äù counts active items in the collection. ‚ÄúSubject Areas‚Äù counts distinct subject
      metadata values (many legacy records are currently ‚Äúunspecified‚Äù while enrichment runs), and
      ‚ÄúResource Collections‚Äù shows active sources with at least one resource. Charts and tables use
      the same data.
    </small>
  </div>
</div>

<div class="row">
  <!-- Left column: subjects + sources -->
  <div class="col-md-6 mb-4">
    <div class="card mb-3 shadow-sm">
      <div class="card-header">
        <h2 class="h5 mb-0">Top Subject Areas</h2>
      </div>
      <div class="card-body">
        {% if top_subjects %}
          <ul class="list-group list-group-flush">
            {% for s in top_subjects %}
              <li class="list-group-item d-flex justify-content-between align-items-center">
                {{ s.subject }}
                <span class="badge bg-secondary rounded-pill">{{ s.count }}</span>
              </li>
            {% endfor %}
          </ul>
        {% endif %}
      </div>
    </div>

    <div class="card shadow-sm">
      <div class="card-header">
        <h2 class="h5 mb-0">Resource Collections</h2>
      </div>
      <div class="card-body">
        {% if sources %}
          <ul class="list-group list-group-flush">
            {% for s in sources %}
              <li class="list-group-item d-flex justify-content-between align-items-center">
                {{ s|source_badge }}
                <span class="badge bg-secondary rounded-pill">{{ s.count }}</span>
              </li>
            {% endfor %}
          </ul>
        {% else %}
          <div class="text-center py-3">
            <p class="text-muted mb-2">No resource collections configured</p>
            {% if user.is_staff %}
              <a
                href="{% url 'admin:resources_oersource_changelist' %}"
                class="btn btn-sm btn-outline-secondary"
              >
                Configure Sources
              </a>
            {% endif %}
          </div>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- Right column: resource type breakdown + maintenance -->
  <div class="col-md-6 mb-4">
    <div class="card mb-3 shadow-sm">
      <div class="card-header">
        <h2 class="h5 mb-0">Resource Breakdown by Type</h2>
      </div>
      <div class="card-body">
        {% if type_counts %}
          <!-- Chart Canvas -->
          <div class="mb-2" style="height: 300px;">
            <canvas
              id="resourceTypeChart"
              width="400"
              height="400"
              role="img"
              aria-label="Resource types distribution"
            ></canvas>
          </div>

          {% if type_counts.0 %}
            <p class="text-muted small mb-3">
              Most common type:
              {{ type_counts.0.label }}
              ({{ type_counts.0.count }} resources)
            </p>
          {% endif %}

          <ul class="list-group list-group-flush">
            {% for t in type_counts %}
              <li class="list-group-item d-flex justify-content-between align-items-center">
                {{ t.label }}
                <span class="badge bg-secondary rounded-pill">{{ t.count }}</span>
              </li>
            {% endfor %}
          </ul>
        {% else %}
          <div class="text-center py-3">
            <p class="text-muted mb-0">No resource type data available yet</p>
            <small class="text-muted">
              Data will appear after harvest jobs complete.
            </small>
          </div>
        {% endif %}
      </div>
    </div>


    <!-- Staff-only maintenance card -->
    {% if user.is_staff %}
      <div class="card border-warning shadow-sm">
        <div class="card-header bg-warning bg-opacity-10">
          <h2 class="h5 mb-0">‚öôÔ∏è Maintenance</h2>
        </div>
        <div class="card-body">
          <p class="mb-3">
            <strong>Enable AI search for new resources</strong><br>
            <small class="text-muted">
              Generate semantic embeddings to allow intelligent search matching.
              This processes resource content to understand meaning beyond keywords.
            </small>
          </p>
          <a
            href="{% url 'resources:generate_embeddings' %}"
            class="btn btn-warning btn-sm"
          >
            Process New Resources
          </a>
          <a
            href="{% url 'admin:resources_oerresource_changelist' %}"
            class="btn btn-outline-secondary btn-sm"
          >
            View All Resources
          </a>
        </div>
      </div>
    {% endif %}
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Resource Type Breakdown Chart
{% if chart_labels and chart_data %}
const ctx = document.getElementById('resourceTypeChart');
if (ctx) {
  new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels: {{ chart_labels|safe }},
      datasets: [{
        label: 'Resources by Type',
        data: {{ chart_data|safe }},
        backgroundColor: {{ chart_colors|safe }},
        borderWidth: 2,
        borderColor: '#ffffff'
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          position: 'bottom',
          labels: {
            boxWidth: 12,
            padding: 10,
            font: {
              size: 11
            }
          }
        },
        title: {
          display: true,
          text: 'Collection Overview',
          font: {
            size: 14
          }
        },
        tooltip: {
          callbacks: {
            label: function(context) {
              let label = context.label || '';
              let value = context.parsed || 0;
              let total = context.dataset.data.reduce((a, b) => a + b, 0);
              let percentage = ((value / total) * 100).toFixed(1);
              return label + ': ' + value + ' (' + percentage + '%)';
            }
          }
        }
      }
    }
  });
}
{% endif %}
</script>
{% endblock %}
