{% extends "admin/change_form.html" %}
{% load static %}

{% block extrahead %}
{{ block.super }}
<style>
.config-section {
    background: var(--body-bg);
    padding: 15px;
    margin: 10px 0;
    border: 1px solid var(--border-color);
    border-radius: 4px;
    transition: all 0.3s ease;
}
.config-section.hidden {
    display: none;
}
.config-section.active {
    border-left: 4px solid var(--primary);
    background: #f8f9fa;
}
.preset-title {
    color: var(--body-quiet-color);
    font-size: 14px;
    font-weight: bold;
    margin-bottom: 10px;
}
.preset-field {
    font-family: var(--font-family-monospace);
    margin: 5px 0;
    color: var(--body-quiet-color);
}
.preset-button {
    background: var(--primary);
    color: var(--primary-fg);
    border: none;
    padding: 8px 15px;
    border-radius: 3px;
    cursor: pointer;
    font-size: 13px;
    margin: 5px 5px 5px 0;
}
.preset-button:hover {
    background: var(--primary-dark);
}
.preset-button.specific {
    background: var(--secondary);
    font-size: 12px;
    padding: 6px 12px;
}
.source-type-info {
    background: #e7f3ff;
    border: 1px solid #b8d4f0;
    padding: 10px;
    margin: 10px 0;
    border-radius: 4px;
}
.preset-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 10px;
    margin: 10px 0;
}
</style>
<script src="{% static 'admin/js/oer_source_dynamic.js' %}"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize the dynamic form behavior
    if (window.toggleConfigSections) {
        window.toggleConfigSections();
    }
    
    // Update preset configuration function with specific presets
    window.applyPreset = function(sourceType, presetKey) {
        const presets = {
            'API': {
                'oapen': {
                    name: 'OAPEN REST API',
                    description: 'Search OAPEN books via REST API',
                    endpoint: 'https://library.oapen.org/rest/search',
                    params: '{"query": "*", "expand": "metadata"}',
                    headers: '{"Accept": "application/json"}'
                },
                'oapen_books': {
                    name: 'OAPEN REST API (Books)',
                    description: 'OAPEN API restricted to book-level records',
                    endpoint: 'https://library.oapen.org/rest/search',
                    params: '{"query": "type:book", "expand": "metadata"}',
                    headers: '{"Accept": "application/json"}'
                },
                'doab': {
                    name: 'DOAB REST API',
                    description: 'Directory of Open Access Books via REST API',
                    endpoint: 'https://directory.doabooks.org/rest/search',
                    params: '{"query": "*", "expand": "metadata"}',
                    headers: '{"Accept": "application/json"}'
                },
                'merlot': {
                    name: 'MERLOT API',
                    description: 'MERLOT OER Repository API',
                    endpoint: 'https://api.merlot.org/materials',
                    params: '{"format": "json", "per_page": 100}',
                    headers: '{"Accept": "application/json"}'
                }
            },
            'OAIPMH': {
                'oapen': {
                    name: 'OAPEN Library - OER Books',
                    description: 'Harvest open access books from OAPEN via OAI-PMH',
                    url: 'https://library.oapen.org/oai/request',
                    set_spec: ''
                },
                'doab': {
                    name: 'DOAB OAI-PMH',
                    description: 'Directory of Open Access Books via OAI-PMH',
                    url: 'https://directory.doabooks.org/oaipmh',
                    set_spec: 'public'
                },
                'mit': {
                    name: 'MIT OpenCourseWare',
                    description: 'MIT OpenCourseWare OER materials',
                    url: 'https://ocw.mit.edu/oaipmh',
                    set_spec: ''
                }
            },
            'CSV': {
                'oer_commons': {
                    name: 'OER Commons CSV',
                    description: 'OER Commons resource catalog via CSV',
                    url: 'https://www.oercommons.org/export/csv'
                },
                'skills_commons': {
                    name: 'Skills Commons OER',
                    description: 'Skills Commons OER materials catalog',
                    url: 'https://www.skillscommons.org/export/oer.csv'
                }
            }
            ,
            'MARCXML': {
                    'oapen': {
                        name: 'OAPEN MARCXML dump',
                        description: 'OAPEN MARCXML dump (books).',
                        marcxml_url: 'https://memo.oapen.org/file/oapen/OAPENLibrary_MARCXML_books.xml'
                    },
                    'doab': {
                        name: 'DOAB MARCXML dump',
                        description: 'DOAB MARCXML dump (if available). Update to actual dump URL.',
                        marcxml_url: 'https://directory.doabooks.org/metadata/marcxml'
                    }
            }
        };

        const preset = presets[sourceType]?.[presetKey];
        if (!preset) return;

        // Set source type
        const sourceTypeSelect = document.getElementById('id_source_type');
        sourceTypeSelect.value = sourceType;

        // Set common fields
        document.getElementById('id_name').value = preset.name;
        document.getElementById('id_description').value = preset.description;

        // Set type-specific fields
        if (sourceType === 'API') {
            document.getElementById('id_api_endpoint').value = preset.endpoint;
            document.getElementById('id_request_params').value = preset.params;
            document.getElementById('id_request_headers').value = preset.headers;
        } else if (sourceType === 'OAIPMH') {
            document.getElementById('id_oaipmh_url').value = preset.url;
            document.getElementById('id_oaipmh_set_spec').value = preset.set_spec || '';
        } else if (sourceType === 'CSV') {
            document.getElementById('id_csv_url').value = preset.url;
        }

        // Set default harvest settings
        document.getElementById('id_harvest_schedule').value = 'manual';
        document.getElementById('id_max_resources_per_harvest').value = 1000;
        document.getElementById('id_is_active').checked = true;

        // Trigger the change event to update visible sections
        if (window.toggleConfigSections) {
            window.toggleConfigSections();
        }
        
        // Focus on the name field
        document.getElementById('id_name').focus();
        
        // Show non-blocking banner message instead of blocking alert
        showPresetBanner(`Applied ${preset.name} preset configuration!`);
    };
    
    function showPresetBanner(message) {
        let existing = document.querySelector('.preset-applied-banner');
        if (existing) existing.remove();
        const banner = document.createElement('div');
        banner.className = 'preset-applied-banner';
        banner.textContent = message;
        banner.style.background = '#e6ffed';
        banner.style.border = '1px solid #b7f0c2';
        banner.style.padding = '10px';
        banner.style.margin = '10px 0';
        banner.style.borderRadius = '4px';
        const container = document.querySelector('.module.aligned') || document.body;
        container.insertBefore(banner, container.firstChild);
        // auto-hide after 6 seconds
        setTimeout(() => { banner.remove(); }, 6000);
    }
});
</script>
{% endblock %}

{% block after_field_sets %}
<div class="module aligned">
    <h2>Quick Configuration Presets</h2>
    <div class="description">
        Use the buttons below to quickly configure common OER sources with pre-configured settings.
    </div>
    
    <div class="config-section">
        <div class="preset-title">üåê API Sources</div>
        <p>Configure API-based OER sources with pre-configured endpoints</p>
        <div class="preset-grid">
            <button type="button" class="preset-button specific" data-type="API" onclick="applyPreset('API', 'oapen')">
                OAPEN REST API
            </button>
            <button type="button" class="preset-button specific" data-type="API" onclick="applyPreset('API', 'oapen_books')">
                OAPEN (Books)
            </button>
            <button type="button" class="preset-button specific" data-type="API" onclick="applyPreset('API', 'doab')">
                DOAB API
            </button>
            <button type="button" class="preset-button specific" data-type="API" onclick="applyPreset('API', 'merlot')">
                MERLOT API
            </button>
        </div>
    </div>

    <div class="config-section">
        <div class="preset-title">üìö OAI-PMH Sources</div>
        <p>Configure OAI-PMH compatible repositories</p>
        <div class="preset-grid">
            <button type="button" class="preset-button specific" data-type="OAIPMH" onclick="applyPreset('OAIPMH', 'oapen')">
                OAPEN OAI-PMH
            </button>
            <button type="button" class="preset-button specific" data-type="OAIPMH" onclick="applyPreset('OAIPMH', 'doab')">
                DOAB OAI-PMH
            </button>
            <button type="button" class="preset-button specific" data-type="OAIPMH" onclick="applyPreset('OAIPMH', 'mit')">
                MIT OCW
            </button>
        </div>
    </div>

    <div class="config-section">
        <div class="preset-title">üìä CSV Sources</div>
        <p>Configure CSV file sources from major OER repositories</p>
        <div class="preset-grid">
            <button type="button" class="preset-button specific" data-type="CSV" onclick="applyPreset('CSV', 'oer_commons')">
                OER Commons
            </button>
            <button type="button" class="preset-button specific" data-type="CSV" onclick="applyPreset('CSV', 'skills_commons')">
                Skills Commons
            </button>
        </div>
    </div>

            <div class="config-section">
                <div class="preset-title">üìú MARCXML / Dump Sources</div>
                <p>Configure MARCXML dump-based sources for book-level imports</p>
                <div class="preset-grid">
                    <button type="button" class="preset-button specific" data-type="MARCXML" onclick="applyPreset('MARCXML', 'oapen')">
                        OAPEN MARCXML
                    </button>
                    <button type="button" class="preset-button specific" data-type="MARCXML" onclick="applyPreset('MARCXML', 'doab')">
                        DOAB MARCXML
                    </button>
                </div>
            </div>
</div>
{% endblock %}